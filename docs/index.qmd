---
title: "Humpback whale distributions and insight into preferred oceanographic conditions in the Caribbean using passive acoustic monitoring (PAM) and an autonomous underwater vehicle (AUV)"
author: "Keiley Gregory"
date: today
bibliography: references.bib
format:
  html:
    css: style.css
    theme: flatly
    highlight-style: tango
---

Previous studies have established that humpback whale (*Megaptera novaeangliae*) distributions in the Caribbean are distinctly seasonal, with the majority of detections occurring in winter and early spring when this species travels south towards warm, protected waters for the breeding and calving season [@mignuccigiannoni1998]; [@debrot2013]; [@bolaños-jiménez2021]. Marine ecosystems throughout the Caribbean act as primary habitats for a multitude of marine mammal species. The environmental conditions present in areas of high species abundance can provide crucial insight into the relationship between oceanographic and geomorphic conditions and marine mammal spatial distribution patterns. There is a limited availability of recent comprehensive research that characterizes the relationship between marine mammal distributions and oceanographic conditions in the Caribbean, specifically surrounding Puerto Rico (PR) and the Virgin Islands (VI). The currently available knowledge on this topic in the Caribbean is predominately based on survey methods such as sightings and stationary acoustic monitoring devices [@mignuccigiannoni1998]; [@debrot2013]; [@kono-martínez2017]; [@heenehan2019].

Ocean gliders provide a multitude of advantages for field-based marine mammal research, including continuous data collection capabilities that are not constrained by spatial, weather-related, or human safety limitations [@wall2017]; [@baumgartner2020]. The research discussed in this document is part of an on-going study using autonomous underwater Teledyne Webb Research (TWR) G3 Slocum gliders equipped with DMON2 passive acoustic monitoring (PAM) technology and various oceanographic sensors to expand the current understanding of the mechanisms driving the multifaceted relationship between environmental conditions and cetacean distribution and habitat use patterns in the Caribbean.

# Humpback Whale Distributions

*M. novaeangliae* detections were determined through analysis of the low-frequency acoustic data collected by the DMON2 hydrophone over the span of a 19-day TWR G3 Slocum Glider mission (March 6-24, 2025) as it traveled by the shelf edge south of Saint Thomas, U.S. Virgin Islands to the northern coast of Saint Croix, east along the perimeter of the Saint Croix Basin and Saba Bank, and northwest back into the Virgin Islands Basin. The geographic location of the glider at the time of each manually verified humpback vocalization recorded in the acoustic data was interpolated as a point on the mission path line in order to visually and quantitatively analyze trends in species distribution across a variety of habitat types.

![**Fig. 1.** Map of humpback whale detections during a Slocum Glider mission from March 6-24, 2025 off the coast of the U.S. Virgin Islands. Each of the circular, off-white points represents an individual *M. novaeangliae* detection as determined through acoustic analysis, and the white line represents the glider mission path with each black-outlined segment depicting the period between surfacing events. VIB represents the Virgin Islands Basin and SCB represents the Saint Croix Basin (ArcGIS Pro version 3.3.1).](figures/MES565_FINALMAP.jpg)

During this glider mission, nearly half (42.74%) of the humpback whale detections occurred in ocean basins, consisting a small cluster of detections in the eastern Virgin Islands Basin at the beginning of the mission (n=18), another small cluster along the southern side of the Saint Croix Basin approximately a week after deployment (n=16), and a large, dense cluster (n=78) spanning the edge of the basin where the northeastern tips of the Aves Ridge and Muertos Trough meet. The vast majority of the remaining detections occurred over areas characterized by gradient seafloor morphology, ranging from slopes (29%) with a moderate pitch to escarpments (25.95%) with a severe incline. A very small proportion of the detections occurred in canyons (2.29%; **Fig. 1**; **Table 1**).

```{r, include=FALSE}
library(tidyverse)
library(ggridges)  # for ridge plots
library(patchwork) # optional, for combining plots
library(knitr)
library(kableExtra) # optional but makes it prettier
```

```{r, include=FALSE}
# Import humpback DETECTION data with GIS calculations
hbk <- read_csv("data/GISCALC_HUWH_AroundSTX2025.csv")

# Rename NEAR_DIST col to match arc background dataframe
hbk <- hbk %>%
  rename(NEAR_DIST_m = NEAR_DIST)

# Create df for seafloor morphology data
seafloor <- hbk %>%
  select(datetime_UTC, datetime_AST, Latitude, Longitude, Primary_Seafloor_Feature, Seafloor_Morphology, RASTERDEPTH_m, RASTERSLOPE_deg, NEAR_DIST_m, Nearest_Shoreline)
```

```{r, include=FALSE}
# Print list of all unique values in Primary_Seafloor_Feature col
print(unique(seafloor$Primary_Seafloor_Feature))
# "Basin" ~ "Basin (near bottom of canyon)" ~ "Saint Croix Basin" ~ "Virgin Islands Basin"    
# "Escarpment" ~ "Escarpment (near Saba Bank)"                  
# "Slope" ~ "Slope (near Saba Bank)"                     
# "Canyon"

# Count number of rows with each seafloor morphology type (*use partial matching (e.g., anything containing “Basin”))
nrow(seafloor %>% filter(str_detect(Primary_Seafloor_Feature, "Basin"))) # n = 112
nrow(seafloor %>% filter(str_detect(Primary_Seafloor_Feature, "Escarpment"))) # n = 68
nrow(seafloor %>% filter(str_detect(Primary_Seafloor_Feature, "Slope"))) # n = 76
# *DONT* use  partial matching for canyon so doesn't pick up "Basin (near bottom of canyon)"
nrow(seafloor %>% filter(Primary_Seafloor_Feature == "Canyon")) # n = 6
# total n = 262 = perfect yay

# Count detections by specific Basin types
n_vib <- nrow(seafloor %>% filter(Primary_Seafloor_Feature == "Virgin Islands Basin")) # n = 18
n_scb <- nrow(seafloor %>% filter(Primary_Seafloor_Feature == "Saint Croix Basin"))    # n = 16
```

```{r, include=FALSE}
# Values
vib_label <- "Virgin Islands Basin"
scb_label <- "Saint Croix Basin"

# Build styled tibble manually
seafloor_summary <- tibble(
  Feature = c(
    "Basin",
    cell_spec(vib_label, "html", extra_css = "font-size:80%; padding-left:20px;"),
    cell_spec(scb_label, "html", extra_css = "font-size:80%; padding-left:20px;"),
    "Slope",
    "Escarpment",
    "Canyon"
  ),
  Detections = c(
    112,
    cell_spec(18, "html", extra_css = "font-size:80%"),
    cell_spec(16, "html", extra_css = "font-size:80%"),
    76,
    68,
    6
  ),
  Percent = c(
    42.74,
    cell_spec(6.87, "html", extra_css = "font-size:80%"),
    cell_spec(6.11, "html", extra_css = "font-size:80%"),
    29.00,
    25.95,
    2.29
  )
)
```

```{r, echo=FALSE}
# Render with escape = FALSE so inline HTML is rendered
seafloor_summary %>%
  kable(
    format = "html",
    escape = FALSE,
    caption = "<b>Table 1.</b> The distribution of <i>M. novaeangliae</i> detections across areas with varying morphological seafloor characteristics during a Slocum glider mission near the U.S. Virgin Islands in March of 2025.",
    col.names = c(
      "Seafloor Morphology Type",
      "Number of Humpback Whale Detections (n)",
      "Percent of Total Detections (%)"
    ),
    align = "l"
  ) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

# Oceanographic Conditions

\*overview of findings for preferred oceanographic conditions

```{r, include=FALSE}
# Import *GLIDER* BACKGROUND mission data
gld <- read_csv("data/erddap_UVI2_Around_STX_20250306.csv")

# Import *ARC* BACKGROUND mission data
arc <- read_csv("data/arcgis_UVI2_Around_STX_20250306.csv")
```

```{r, include=FALSE}
# Create DETECTIONS summary table dataframe
hbk_summary <- hbk %>%
  select("Glider_depth_m", "Water_temperature_C", "Salinity_PSU", "Oxygen_concentration_µmol_L", "RASTERDEPTH_m", "RASTERSLOPE_deg", "NEAR_DIST_m") %>%
  pivot_longer(
    cols = everything(),
    names_to  = "Oceanographic_Variable",
    values_to = "Value"
  ) %>%
  group_by(Oceanographic_Variable) %>%
  summarise(
    n     = sum(!is.na(Value)),
    Mean  = mean(Value, na.rm = TRUE),
    SEM   = sd(Value, na.rm = TRUE) / sqrt(n),
    SD    = sd(Value, na.rm = TRUE),
    Min   = min(Value, na.rm = TRUE),
    Max   = max(Value, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    Oceanographic_Variable = case_when(
      Oceanographic_Variable == "Glider_depth_m" ~ "Glider Depth (m)",
      Oceanographic_Variable == "Water_temperature_C" ~ "Water Temperature (°C)",
      Oceanographic_Variable == "Salinity_PSU" ~ "Salinity (PSU)",
      Oceanographic_Variable == "Oxygen_concentration_µmol_L" ~ "Dissolved Oxygen Concentration (µmol/L)",
      Oceanographic_Variable == "RASTERDEPTH_m" ~ "Bathymetric Depth (m)",
      Oceanographic_Variable == "RASTERSLOPE_deg" ~ "Bathymetric Slope (°)",
      Oceanographic_Variable == "NEAR_DIST_m" ~ "Distance to Nearest Shoreline (m)",
      TRUE ~ Oceanographic_Variable
    )
  )

# Reorder rows for table
hbk_summary <- hbk_summary %>%
  mutate(
    Oceanographic_Variable = factor(Oceanographic_Variable,
    levels = c(
      "Glider Depth (m)",
      "Water Temperature (°C)",
      "Salinity (PSU)",
      "Dissolved Oxygen Concentration (µmol/L)",
      "Bathymetric Depth (m)",
      "Bathymetric Slope (°)",
      "Distance to Nearest Shoreline (m)"
      )
    )
  ) %>%
  arrange(Oceanographic_Variable)

# Export as CSV
write_csv(hbk_summary, "data/output_summary_tables/hbk_summary.csv")
```

```{r, include=FALSE}
# Create **GLIDER** BACKGROUND summary table dataframe
gld_summary <- gld %>%
  select("Glider_depth_m", "Water_temperature_C", "Salinity_PSU", "Oxygen_concentration_µmol_L") %>%
  pivot_longer(
    cols = everything(),
    names_to  = "Oceanographic_Variable",
    values_to = "Value"
    ) %>%
  group_by(Oceanographic_Variable) %>%
  summarise(
    n     = sum(!is.na(Value)),
    Mean  = mean(Value, na.rm = TRUE),
    SEM   = sd(Value, na.rm = TRUE) / sqrt(n),
    SD    = sd(Value, na.rm = TRUE),
    Min   = min(Value, na.rm = TRUE),
    Max   = max(Value, na.rm = TRUE),
    .groups = "drop"
    ) %>%
  mutate(
    Oceanographic_Variable = case_when(
      Oceanographic_Variable == "Glider_depth_m" ~ "Glider Depth (m)",
      Oceanographic_Variable == "Water_temperature_C" ~ "Water Temperature (°C)",
      Oceanographic_Variable == "Salinity_PSU" ~ "Salinity (PSU)",
      Oceanographic_Variable == "Oxygen_concentration_µmol_L" ~ "Dissolved Oxygen Concentration (µmol/L)",
      TRUE ~ Oceanographic_Variable
      )
    )

# Reorder rows for table
gld_summary <- gld_summary %>%
  mutate(
    Oceanographic_Variable = factor(Oceanographic_Variable,
    levels = c(
      "Glider Depth (m)",
      "Water Temperature (°C)",
      "Salinity (PSU)",
      "Dissolved Oxygen Concentration (µmol/L)"
      )
    )
  ) %>%
  arrange(Oceanographic_Variable)

# Export as CSV
write_csv(gld_summary, "data/output_summary_tables/gld_summary.csv")
```

```{r, include=FALSE}
# Create **ARC** BACKGROUND summary table dataframe (note that this df does not need select() or pivot_longer() commands used for hbk and gld dataframes because it is already in long format and only has 2 columns that are both required for summary table)
arc_summary <- arc %>%
  group_by(Oceanographic_Variable) %>%
  summarise(
    n    = sum(!is.na(Value)),
    Mean = mean(Value, na.rm = TRUE),
    SEM  = sd(Value, na.rm = TRUE) / sqrt(n),
    SD   = sd(Value, na.rm = TRUE),
    Min  = min(Value, na.rm = TRUE),
    Max  = max(Value, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    Oceanographic_Variable = case_when(
      Oceanographic_Variable == "RASTERDEPTH_m" ~ "Bathymetric Depth (m)",
      Oceanographic_Variable == "RASTERSLOPE_deg" ~ "Bathymetric Slope (°)",
      Oceanographic_Variable == "NEAR_DIST_m" ~ "Distance to Nearest Shoreline (m)",
      TRUE ~ Oceanographic_Variable
    )
  )

# Reorder rows for table
arc_summary <- arc_summary %>%
  mutate(
    Oceanographic_Variable = factor(Oceanographic_Variable,
    levels = c(
      "Bathymetric Depth (m)",
      "Bathymetric Slope (°)",
      "Distance to Nearest Shoreline (m)"
      )
    )
  ) %>%
  arrange(Oceanographic_Variable)

# Export as CSV
write_csv(arc_summary, "data/output_summary_tables/arc_summary.csv")
```

```{r, include=FALSE}
# Join BOTH BACKGROUND (gld_summary + arc_summary) summary table dataframes
background_summary <- bind_rows(
  gld_summary %>% select(Oceanographic_Variable, n, Mean, SEM, SD, Min, Max),
  arc_summary %>% select(Oceanographic_Variable, n, Mean, SEM, SD, Min, Max)
  ) %>%
  rename(
    `n Background` = n,
    `Background Conditions Mean` = Mean,
    `Background Conditions SEM` = SEM,
    `Background Conditions SD` = SD,
    `Background Conditions Min` = Min,
    `Background Conditions Max` = Max
  )

# Join HBK DETECTION summary df with BACKGROUND (ARC + GLD) mission summary dfs by Oceanographic_Variable col
join_summary <- hbk_summary %>%
  left_join(background_summary, by = "Oceanographic_Variable")

# Export as CSV
write_csv(join_summary, "data/output_summary_tables/join_summary.csv")
```

```{r, include=FALSE}
# Remove glider depth row (not included bc not really an oceanographic variable), calculate new `Difference in Means` col, rename Oceanographic_Variable col, and remove "n" and "gld_Mean" columns + set col order
summary_table <- join_summary %>%
  filter(Oceanographic_Variable != "Glider Depth (m)") %>%
  mutate(
    `Difference in Means` = 
      sprintf("%+.4f",  # sprintf("%+.4f") forces +/- sign and 4 decimal places
              Mean - `Background Conditions Mean`
              )
    ) %>%
  rename(
    "Oceanographic Variable" = Oceanographic_Variable,
    "Detection Conditions Mean" = Mean,
    "Detection Conditions SEM" = SEM,
    "Detection Conditions SD" = SD,
    "Detection Conditions Min" = Min,
    "Detection Conditions Max" = Max
    ) %>%
  select(
    "Oceanographic Variable", 
    "Detection Conditions Mean", 
    "Detection Conditions SEM", 
    "Detection Conditions SD", 
    "Detection Conditions Min", 
    "Detection Conditions Max", 
    "Background Conditions Mean", 
    "Difference in Means"
    )

# Export as CSV
write_csv(summary_table, "data/output_summary_tables/summary_table.csv")
```

```{r, echo=FALSE}
summary_table %>%
  kable(
    format = "html",
    escape = FALSE,
    caption = "<b>Table 2.</b> Summary table of descriptive statistics calculated for each of the oceanographic variables measured during the glider mission. The mean, standard error of the mean (SEM), standard deviation (SD), minimum, and maximum values were calculated from variable measurements recorded during <i>M. novaeangliae</i> detections (columns 2-5). The mean of variable measurements recorded continuously throughout the 19-day mission (column 6) and the difference between the means of oceanographic variables recorded during detections versus continuously (column 7) were also computed to provide context on how the oceanographic conditions present during species detections were influenced by the overall environmental setting of the mission.",
    digits = 2, 
    align = "l"
    ) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

```{r, include=FALSE}
# Create custom color scheme for oceanographic variables
custom_colors <- c(
  Water_temperature_C = "#7600d1",
  Salinity_PSU = "#1002bd",
  Oxygen_concentration_µmol_L = "#908bc9",
  RASTERDEPTH_m = "#a45cad",
  RASTERSLOPE_deg = "#e632ad",
  NEAR_DIST_m = "#ffa100"
  )
```

```{r, include=FALSE}
# Create vector of clean variable names
clean_var_names <- c(
  Water_temperature_C = "Water Temperature (°C)",
  Salinity_PSU = "Salinity (PSU)",
  Oxygen_concentration_µmol_L = "Dissolved Oxygen Concentration (µmol/L)",
  RASTERDEPTH_m = "Bathymetric Depth (m)",
  RASTERSLOPE_deg = "Bathymetric Slope (°)",
  NEAR_DIST_m = "Distance to Nearest Shoreline (m)"
  )
```

```{r, include=FALSE}
# Vector of environmental variables to summarize for table (*EXCLUDE glider depth because not really an environmental variable)
env_vars <- c(
  "Water_temperature_C",
  "Salinity_PSU",
  "Oxygen_concentration_µmol_L",
  "RASTERDEPTH_m",
  "RASTERSLOPE_deg",
  "NEAR_DIST_m"
  )
```

```{r, include=FALSE}
# Pivot longer DETECTION data
hbk_long <- hbk %>%
  select(all_of(env_vars)) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Oceanographic_Variable",
    values_to = "Value"
  ) %>%
  mutate(
    Oceanographic_Variable = factor(
      Oceanographic_Variable,
      levels = c(
        "Water_temperature_C",
        "Salinity_PSU",
        "Oxygen_concentration_µmol_L",
        "RASTERDEPTH_m",
        "RASTERSLOPE_deg",
        "NEAR_DIST_m"
        )
      )
    ) %>%
  filter(!is.na(Value)) # drop non-finite values
```

```{r, include=FALSE}
# Pivot longer *GLIDER* BACKGROUND data
gld_long <- gld %>%
  select("Water_temperature_C", "Salinity_PSU", "Oxygen_concentration_µmol_L") %>%
  pivot_longer(
    cols = everything(),
    names_to = "Oceanographic_Variable",
    values_to = "Value"
  ) %>%
  mutate(
    Oceanographic_Variable = factor(
      Oceanographic_Variable,
      levels = c(
        "Water_temperature_C",
        "Salinity_PSU",
        "Oxygen_concentration_µmol_L"
        )
      )
    ) %>%
  filter(!is.na(Value))  # drop non-finite values

# !! DO NOT NEED TO PIVOT LONGER FOR *ARC* BACKGROUND DATA BECAUSE DF ALREADY IN LONG FORMAT

# Combine GLIDER + ARC BACKGROUND long data
background_long <- bind_rows(gld_long, arc) %>%
  mutate(
    Oceanographic_Variable = factor(
      Oceanographic_Variable,
      levels = c(
        "Water_temperature_C",
        "Salinity_PSU",
        "Oxygen_concentration_µmol_L",
        "RASTERDEPTH_m",
        "RASTERSLOPE_deg",
        "NEAR_DIST_m"
      )
    )
  ) %>%
  filter(!is.na(Value))  # drop non-finite values
```

```{r density-combined, echo=FALSE, fig.cap="**Fig. 2.** Density distributions of oceanographic variable conditions throughout the March 2025 glider mission. The colored distribution curves in each variable plot represent the conditions measured during *M. novaeangliae* detections. The gray distribution curves represent the overall background conditions recorded continuously throughout the 19-day mission, allowing for the interpretation of how trends in the oceanographic conditions recorded during *M. novaeangliae* detections were influenced by the overall environmental setting of the mission."}

# Faceted density plot
density_COMBINED <- ggplot() +
  # BACKGROUND density (grey)
  geom_density(data = background_long, 
               aes(x = Value, y = after_stat(density)),
               fill = "grey70",
               color = "grey65",
               alpha = 0.5,
               linewidth = 0.65
  ) +
  # DETECTION density (colored by variable)
  geom_density(data = hbk_long, 
               aes(x = Value, y = after_stat(density), fill = Oceanographic_Variable, color = Oceanographic_Variable),
               alpha = 0.5,
               linewidth = 0.75
  ) +
  facet_wrap(
    ~ Oceanographic_Variable,
    scales = "free",
    ncol = 3,
    labeller = labeller(
      Oceanographic_Variable = function(x) {
        stringr::str_wrap(clean_var_names[x], width = 18)
        }
      )
  ) +
  scale_fill_manual(values = custom_colors, guide = "none") +
  scale_color_manual(values = custom_colors, guide = "none") +
  labs(
    x = "Value",
    y = "Density"
  ) +
  theme_minimal(base_size = 10) +
  theme(
    text        = element_text(color = "black"),
    strip.text  = element_text(color = "black", face = "bold", size = 11),
    axis.text   = element_text(color = "black"),
    axis.title  = element_text(color = "black"),
    axis.title.x = element_text(face = "bold", size = 10, margin = margin(t = 5)),
    axis.title.y = element_text(face = "bold", size = 10, margin = margin(r = 5)),
    axis.ticks.x = element_blank()
  )
density_COMBINED
```

future research - study will use data from more missions in different areas, compare findings between missions, overall patterns, blah blah
